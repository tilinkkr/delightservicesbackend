<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details | Delight Services Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">

    <div class="max-w-4xl mx-auto py-10 px-6">

        <!-- Header / Nav -->
        <div class="flex items-center justify-between mb-8">
            <a href="orders.html" class="flex items-center text-gray-500 hover:text-gray-800 transition-colors">
                <i class="fa-solid fa-arrow-left mr-2"></i>
                Back to Orders
            </a>
            <div class="flex items-center gap-3" id="action-buttons">
                <button id="btn-cancel" onclick="cancelThisOrder()"
                    class="flex items-center gap-2 bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 transition-colors shadow-sm">
                    <i class="fa-solid fa-ban"></i>
                    Cancel Order
                </button>
                <button onclick="window.print()"
                    class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                    <i class="fa-solid fa-print"></i>
                    Print Invoice
                </button>
            </div>
        </div>

        <!-- Order Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden" id="order-container">

            <!-- Loading State -->
            <div class="p-12 text-center animate-pulse">
                <div class="h-8 w-48 bg-gray-200 rounded mx-auto mb-4"></div>
                <div class="h-4 w-64 bg-gray-100 rounded mx-auto"></div>
            </div>

        </div>

    </div>

    <!-- Auth & Logic -->
    <script type="module">
        import { checkAuth, getToken } from './adminAuth.js';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!await checkAuth()) return;
            loadOrderDetails();
        });

        async function loadOrderDetails() {
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            const container = document.getElementById('order-container');
            const actionButtons = document.getElementById('action-buttons');

            if (!orderId) {
                container.innerHTML = `<div class="p-12 text-center text-red-500">No Order ID Provided</div>`;
                return;
            }

            try {
                const token = await getToken();
                const res = await fetch(`/api/admin/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Order not found or access denied');

                const data = await res.json();
                renderOrder(data, container, actionButtons);

            } catch (err) {
                console.error(err);
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-red-500 font-bold mb-2">Error Loading Order</div>
                        <div class="text-gray-500 text-sm">${err.message}</div>
                        <a href="orders.html" class="inline-block mt-4 text-blue-600 hover:underline">Return to List</a>
                    </div>`;
            }
        }

        function renderOrder(order, container, actionContainer) {
            // Helper: Format Currency
            const fmt = (n) => 'â‚¹' + (n || 0).toLocaleString('en-IN');
            const date = new Date(order.created_at).toLocaleString('en-IN', {
                day: 'numeric', month: 'long', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            // Status Colors
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-800',
                processing: 'bg-blue-100 text-blue-800',
                shipped: 'bg-indigo-100 text-indigo-800',
                delivered: 'bg-green-100 text-green-800',
                cancelled: 'bg-red-100 text-red-800'
            };
            const badgeClass = statusColors[order.status] || 'bg-gray-100 text-gray-800';

            // Items HTML
            const itemsHtml = (order.order_items || []).map(item => {
                const product = item.products || { name: 'Unknown Product', image_url: null };
                const total = item.quantity * item.price;

                return `
                <tr>
                    <td class="py-4 pl-0 pr-4">
                        <div class="flex items-center">
                            ${product.image_url
                        ? `<img src="${product.image_url}" class="h-10 w-10 rounded border border-gray-200 mr-3 object-cover">`
                        : `<div class="h-10 w-10 rounded bg-gray-100 border border-gray-200 mr-3 flex items-center justify-center text-gray-400"><i class="fa-solid fa-box"></i></div>`
                    }
                            <div>
                                <div class="font-medium text-gray-900">${product.name}</div>
                                <div class="text-xs text-gray-500">Unit: ${fmt(item.price)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-center text-gray-600">${item.quantity}</td>
                    <td class="py-4 pl-4 pr-0 text-right font-medium text-gray-900">${fmt(total)}</td>
                </tr>
                `;
            }).join('');

            // UPDATE HEADER BUTTONS DYNAMICALLY
            // Clear previous buttons
            if (actionContainer) {
                // Keep Print button, remove others
                const printBtn = actionContainer.querySelector('button[onclick="window.print()"]');
                actionContainer.innerHTML = '';

                // 1. Mark as Shipped (if pending/processing)
                if (['pending', 'processing'].includes(order.status)) {
                    actionContainer.innerHTML += `
                        <button onclick="updateStatus('shipped')" class="flex items-center gap-2 bg-blue-50 text-blue-600 border border-blue-200 px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors shadow-sm">
                            <i class="fa-solid fa-truck-fast"></i> Mark Shipped
                        </button>`;
                }

                // 2. Mark as Delivered (if shipped)
                if (order.status === 'shipped') {
                    actionContainer.innerHTML += `
                        <button onclick="updateStatus('delivered')" class="flex items-center gap-2 bg-green-50 text-green-600 border border-green-200 px-4 py-2 rounded-lg hover:bg-green-100 transition-colors shadow-sm">
                            <i class="fa-solid fa-check-circle"></i> Mark Delivered
                        </button>`;
                }

                // 3. Cancel Order (if pending/processing)
                if (['pending', 'processing'].includes(order.status)) {
                    actionContainer.innerHTML += `
                        <button onclick="cancelThisOrder()" class="flex items-center gap-2 bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 transition-colors shadow-sm">
                            <i class="fa-solid fa-ban"></i> Cancel Order
                        </button>`;
                }

                // Always add Print back
                if (printBtn) actionContainer.appendChild(printBtn);
                else {
                    actionContainer.innerHTML += `
                    <button onclick="window.print()" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                        <i class="fa-solid fa-print"></i> Print Invoice
                    </button>`;
                }
            }

            // Full Template
            container.innerHTML = `
                <!-- Invoice Header -->
                <div class="bg-gray-50 px-8 py-6 border-b border-gray-200 flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 mb-1">Order #${order.id.slice(0, 8).toUpperCase()}</h1>
                        <p class="text-sm text-gray-500">Placed on ${date}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${badgeClass}">
                            ${order.status}
                        </span>
                    </div>
                </div>
                
                <!-- Content Grid -->
                <!-- Reuse container structure -->
                <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-12">
                     <!-- Customer Details -->
                    <div>
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Customer Details</h3>
                        <div class="flex items-start mb-4">
                            <div class="flex-shrink-0 mt-1">
                                <span class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                    <i class="fa-solid fa-user"></i>
                                </span>
                            </div>
                            <div class="ml-4">
                                <div class="font-medium text-gray-900">${order.profiles ? order.profiles.full_name : 'Unknown User'}</div>
                                <div class="text-sm text-gray-500">${order.profiles ? order.profiles.email : 'No Email'}</div>
                            </div>
                        </div>
                        
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 mt-8">Shipping Address</h3>
                         <div class="flex items-start">
                            <div class="flex-shrink-0 mt-1">
                                <span class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                    <i class="fa-solid fa-location-dot"></i>
                                </span>
                            </div>
                            <div class="ml-4 text-sm text-gray-600 leading-relaxed">
                                ${order.shipping_address
                    ? order.shipping_address.replace(/\n/g, '<br>')
                    : '<span class="italic text-gray-400">No address provided</span>'}
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div>
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Order Summary</h3>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-500 border-b border-gray-100 text-xs uppercase">
                                    <th class="py-2 text-left font-medium">Product</th>
                                    <th class="py-2 text-center font-medium">Qty</th>
                                    <th class="py-2 text-right font-medium">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${itemsHtml}
                            </tbody>
                            <tfoot class="border-t border-gray-200">
                                <tr>
                                    <td colspan="2" class="py-3 text-right text-gray-500">Subtotal</td>
                                    <td class="py-3 text-right font-medium text-gray-900">${fmt(order.total_amount)}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="py-3 text-right text-lg font-bold text-gray-900">Grand Total</td>
                                    <td class="py-3 text-right text-lg font-bold text-blue-600">${fmt(order.total_amount)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        }

        // Generic Status Update
        window.updateStatus = async (status) => {
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            const token = await getToken();

            if (!confirm(`Mark this order as ${status.toUpperCase()}?`)) return;

            try {
                const res = await fetch(`/api/admin/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (!res.ok) throw new Error('Update failed');
                window.location.reload();
            } catch (err) {
                alert(err.message);
            }
        };

        // Cancel Wrapper
        window.cancelThisOrder = () => window.updateStatus('cancelled');

        window.loadOrderDetails = loadOrderDetails;
    </script>
</body>

</html>