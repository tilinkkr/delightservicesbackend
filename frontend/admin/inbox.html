<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Support Inbox | Delight Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Inbox List -->
    <div class="w-1/3 bg-slate-900 border-r border-slate-800 flex flex-col">
        <div class="p-6 border-b border-slate-800">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-xl font-bold">Inbox</h2>
                <a href="dashboard.html" class="text-xs text-slate-500 hover:text-white uppercase font-bold">Exit</a>
            </div>
            <p class="text-xs text-slate-500">Concierge Support / Inquiries</p>
        </div>
        <div id="inbox-list" class="flex-1 overflow-y-auto p-4 space-y-2">
            <div class="text-center text-slate-600 py-10">Loading messages...</div>
        </div>
    </div>

    <!-- Conversation -->
    <div class="flex-1 bg-slate-900/50 flex flex-col relative">
        <!-- Empty State -->
        <div id="empty-state" class="absolute inset-0 flex items-center justify-center text-slate-600">
            <div class="text-center">
                <span class="text-4xl block mb-2">ðŸ“©</span>
                <p>Select a conversation to view details</p>
            </div>
        </div>

        <div id="active-view" class="hidden flex-col h-full">
            <div class="p-6 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
                <div>
                    <h3 id="msg-subject" class="text-lg font-bold text-white">--</h3>
                    <p id="msg-email" class="text-sm text-slate-400">--</p>
                    <span id="msg-status"
                        class="inline-block mt-1 px-2 py-0.5 rounded text-[10px] bg-slate-800 text-slate-400 uppercase font-bold">--</span>
                </div>
                <button onclick="markResolved()"
                    class="text-sm text-emerald-500 hover:text-emerald-400 font-medium border border-emerald-500/30 px-3 py-1.5 rounded-lg hover:bg-emerald-500/10 transition-colors">
                    âœ“ Mark Resolved
                </button>
            </div>

            <div id="conversation-body" class="flex-1 overflow-y-auto p-8 space-y-6">
                <div
                    class="bg-slate-800 p-5 rounded-tr-xl rounded-br-xl rounded-bl-xl max-w-2xl border border-slate-700">
                    <p id="msg-content" class="text-slate-200 leading-relaxed">--</p>
                    <span class="block mt-3 text-xs text-slate-500 text-right">Received from User</span>
                </div>
            </div>

            <div class="p-6 bg-slate-900 border-t border-slate-800">
                <textarea id="reply" placeholder="Type your reply here..."
                    class="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl text-white placeholder-slate-500 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none h-32 mb-3"></textarea>
                <div class="flex justify-end">
                    <button onclick="sendReply()"
                        class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-500 transition-colors shadow-lg shadow-blue-600/20">
                        Send Reply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAdminToken } from './adminAuth.js';

        let activeInquiry = null;
        const API_URL = '/api/admin';

        async function loadInbox() {
            const token = await getAdminToken();
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/inquiries`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const items = await res.json();

                const list = document.getElementById('inbox-list');
                list.innerHTML = '';

                if (items.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-600 py-10">Inbox is empty.</div>';
                    return;
                }

                items.forEach(i => {
                    const isResolved = i.status === 'resolved';
                    list.innerHTML += `
          <div onclick="openInquiry('${i.id}')" class="p-4 rounded-xl cursor-pointer transition-all hover:bg-slate-800 group border border-transparent hover:border-slate-700 ${activeInquiry === i.id ? 'bg-slate-800 border-slate-700' : ''}">
            <div class="flex justify-between items-start mb-1">
                <h4 class="font-semibold text-white truncate pr-2 group-hover:text-blue-400 transition-colors">${i.subject || 'No Subject'}</h4>
                ${!isResolved ? '<span class="h-2 w-2 rounded-full bg-blue-500 shadow-lg shadow-blue-500/50"></span>' : ''}
            </div>
            <p class="text-xs text-slate-400 mb-2 truncate">${i.email}</p>
            <p class="text-xs text-slate-500 line-clamp-2">${i.message}</p>
          </div>
        `;
                });
            } catch (err) {
                console.error(err);
                document.getElementById('inbox-list').innerHTML = '<div class="text-red-500 p-4 text-center text-sm">Error loading inbox</div>';
            }
        }

        window.openInquiry = async (id) => {
            activeInquiry = id;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-view').classList.remove('hidden');
            document.getElementById('active-view').classList.add('flex');

            const token = await getAdminToken();
            try {
                const res = await fetch(`${API_URL}/inquiries/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();

                document.getElementById('msg-subject').textContent = data.subject;
                document.getElementById('msg-email').textContent = data.email;
                document.getElementById('msg-content').textContent = data.message;
                document.getElementById('msg-status').textContent = data.status;

                // Re-render list to highlight active
                loadInbox();

            } catch (err) {
                alert('Failed to load message');
            }
        };

        window.sendReply = async () => {
            if (!activeInquiry) return;
            const token = await getAdminToken();
            const msg = document.getElementById('reply').value;
            if (!msg) return alert('Please type a message');

            try {
                await fetch(`${API_URL}/inquiries/${activeInquiry}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify({ message: msg })
                });

                alert('âœ“ Reply sent successfully');
                document.getElementById('reply').value = '';
            } catch (err) {
                alert('Failed to send reply');
            }
        };

        window.markResolved = async () => {
            if (!activeInquiry) return;
            const token = await getAdminToken();
            try {
                await fetch(`${API_URL}/inquiries/${activeInquiry}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'resolved' })
                });
                alert('Conversation marked as resolved');
                loadInbox();
            } catch (err) {
                alert('Failed to update status');
            }
        };

        loadInbox();
    </script>

</body>

</html>