<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelliFlow - Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: { display: ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-900 text-white font-display">
    <div class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold">IntelliFlow Tickets</h1>
                    <p class="text-slate-400 mt-1">Automatic AI Analysis Enabled</p>
                </div>
                <button onclick="window.location.href='/static/create.html'"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium flex items-center gap-2">
                    <span class="material-symbols-outlined">add</span>
                    New Ticket
                </button>
            </div>

            <!-- Tickets Table -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-slate-700/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">ID</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">Title</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">Priority</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">AI Status</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">Category</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-slate-400 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsBody" class="divide-y divide-slate-700">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-slate-500">Loading tickets...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let tickets = [];

        async function loadTickets() {
            try {
                const response = await fetch('/tickets');
                tickets = await response.json();
                renderTickets();
            } catch (error) {
                console.error('Error loading tickets:', error);
            }
        }

        function renderTickets() {
            const tbody = document.getElementById('ticketsBody');

            if (tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">No tickets yet. Create one to see automatic AI analysis!</td></tr>';
                return;
            }

            tbody.innerHTML = tickets.slice().reverse().map(ticket => `
                <tr class="hover:bg-slate-700/50 transition-colors cursor-pointer" onclick="window.location.href='/static/detail.html?id=${ticket.id}'">
                    <td class="px-6 py-4 font-mono text-slate-400">#${ticket.id}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium">${escapeHtml(ticket.title)}</div>
                        <div class="text-xs text-slate-500 mt-1">${escapeHtml(ticket.description).substring(0, 60)}...</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityClass(ticket.priority)}">
                            ${ticket.priority || 'Medium'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${ticket.ai_priority ? `
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-green-400 text-sm">check_circle</span>
                                <div>
                                    <div class="text-green-400 text-sm font-medium">AI Analyzed</div>
                                    <div class="text-xs text-slate-500">${ticket.ai_priority} Priority</div>
                                </div>
                            </div>
                        ` : `
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-blue-400 text-sm">Analyzing...</span>
                            </div>
                        `}
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-slate-300">${ticket.category || 'Pending'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="window.location.href='/static/detail.html?id=${ticket.id}'; event.stopPropagation();" 
                            class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getPriorityClass(priority) {
            if (priority === 'High') return 'bg-red-500/20 text-red-400';
            if (priority === 'Low') return 'bg-green-500/20 text-green-400';
            return 'bg-yellow-500/20 text-yellow-400';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load tickets on page load and refresh every 5 seconds
        loadTickets();
        setInterval(loadTickets, 5000);
    </script>
</body>

</html>