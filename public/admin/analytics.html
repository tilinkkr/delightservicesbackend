<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Enterprise Analytics | Delight Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <!-- Chart.js for Visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white">Analytics & Insights</h1>
                <p class="text-slate-400">Deep dive into enterprise performance</p>
            </div>
            <div>
                <a href="dashboard.html" class="text-slate-400 hover:text-white mr-4">← Dashboard</a>
                <select class="bg-slate-800 text-slate-300 border border-slate-700 rounded px-3 py-1 text-sm">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last Quarter</option>
                    <option value="365">Year to Date</option>
                </select>
            </div>
        </header>

        <!-- KPIS -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <p class="text-xs font-bold text-slate-400 uppercase">Total Revenue</p>
                <h3 id="kpi-revenue" class="text-3xl font-bold text-emerald-400 mt-2">--</h3>
                <p class="text-xs text-emerald-500/80 mt-1">↑ 12% vs last month</p>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <p class="text-xs font-bold text-slate-400 uppercase">Total Orders</p>
                <h3 id="kpi-orders" class="text-3xl font-bold text-white mt-2">--</h3>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <p class="text-xs font-bold text-slate-400 uppercase">New Customers</p>
                <h3 id="kpi-customers" class="text-3xl font-bold text-blue-400 mt-2">--</h3>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <p class="text-xs font-bold text-slate-400 uppercase">Conversion Rate</p>
                <h3 id="kpi-conversion" class="text-3xl font-bold text-amber-400 mt-2">--</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Charts Section -->
            <div class="col-span-2 space-y-6">
                <!-- Main Chart -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-bold mb-4">Revenue Trend</h3>
                    <canvas id="revenueChart" height="100"></canvas>
                </div>

                <!-- Secondary Chart -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-bold mb-4">Order Volume (Active vs Returns)</h3>
                    <canvas id="volumeChart" height="100"></canvas>
                </div>
            </div>

            <!-- Insights Column -->
            <div class="space-y-6">
                <!-- AI Insights -->
                <div
                    class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 p-6 rounded-xl border border-indigo-500/30">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2 mb-4">
                        <span class="text-xl">✨</span> AI Insights
                    </h3>
                    <ul id="ai-insights"
                        class="space-y-3 text-sm text-indigo-100/90 list-disc pl-4 marker:text-indigo-400">
                        <li>Loading intelligence...</li>
                    </ul>
                </div>

                <!-- Top Products -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-bold mb-4">Top Performers</h3>
                    <div id="top-products" class="space-y-4">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { getAdminToken } from './adminAuth.js';

        const API_URL = '/api/admin';

        async function loadAnalytics() {
            const token = await getAdminToken();
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/analytics?range=30`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();

                // 1. Update KPIs
                document.getElementById('kpi-revenue').textContent = `₹${data.kpis.revenue.toLocaleString()}`;
                document.getElementById('kpi-orders').textContent = data.kpis.orders;
                document.getElementById('kpi-customers').textContent = data.kpis.new_customers;
                document.getElementById('kpi-conversion').textContent = `${data.kpis.conversion_rate}%`;

                // 2. Charts
                renderRevenueChart(data.revenue_trend);
                renderVolumeChart(data.order_volume);

                // 3. AI Insights
                const insightsList = document.getElementById('ai-insights');
                insightsList.innerHTML = '';
                data.ai_insights.forEach(i => {
                    insightsList.innerHTML += `<li>${i}</li>`;
                });

                // 4. Top Products
                const prodList = document.getElementById('top-products');
                prodList.innerHTML = '';
                data.top_products.forEach(p => {
                    prodList.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg">
                            <div>
                                <p class="font-bold text-sm text-white">${p.name}</p>
                                <p class="text-xs text-slate-400">${p.category} • ${p.sold} sold</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm text-white">₹${p.revenue.toLocaleString()}</p>
                                <p class="text-[10px] text-emerald-400 font-bold">+${p.growth}%</p>
                            </div>
                        </div>
                    `;
                });

            } catch (err) {
                console.error(err);
                alert('Failed to load analytics data');
            }
        }

        function renderRevenueChart(trendData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.label),
                    datasets: [{
                        label: 'Revenue',
                        data: trendData.map(d => d.value),
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function renderVolumeChart(volumeData) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: volumeData.map(d => d.day),
                    datasets: [
                        {
                            label: 'Completed',
                            data: volumeData.map(d => d.completed),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        },
                        {
                            label: 'Returns',
                            data: volumeData.map(d => d.returns),
                            backgroundColor: '#ef4444',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { color: '#94a3b8' } },
                        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        loadAnalytics();
    </script>
</body>

</html>